---
title: "The innards of pisoc.net"
author: "Tom Mitchell"
description: "The (somewhat gory) innards of pisoc.net"
date: 2018-08-18
repo: "https://github.com/pisoc/pisoc.net"
tags: ['python', 'hugo', 'flask', 'github']
draft: false
---

# TL;DR

Our [flask](http://flask.pocoo.org/) app listens for [webhooks](https://developer.github.com/webhooks/) triggered by pushes to the [repository](https://github.com/pisoc/pisoc.net). When it recieves a [POST](https://en.wikipedia.org/wiki/POST_(HTTP)) request to the "webhook endpoint", it pulls the latest versions of the repositories for the website (main and [theme submodule](https://github.com/pisoc/pisoc-minimal)) and uses [Hugo](https://gohugo.io/) to rebuild the static portion of the site.

# In some more detail

## Python and Flask

Flask is a web development "microframework" written in Python. We're using this as the "bridge" between the two functionalities we need for this project: serving web content, and executing commands on the host machine. There are probably "more proper" ways to achieve the same result (some sort of [task queue](http://flask.pocoo.org/docs/1.0/patterns/celery/) running in the background), but this approach is more simple.

### Serving web content

The first of these is achieved with a modification of [`flask.helpers.send_from_directory`](https://github.com/pallets/flask/blob/master/flask/helpers.py#L681). The original method takes a file path and directory as an argument, and if the path is "[below](https://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard)" the directory, returns the file to send to the user.

This wasn't quite fit for purpose because of the way Hugo generates content. Certain resources aren't a file - they are a directory containing a file called  `index.html`. This causes a problem for `send_from_directory` because it only sends single files, not directories, and will fail if you don't give it a file.

For example, the structure for the `news` directory:

```none
news/
├── election-results-2017
│   └── index.html
├── first-gameathon-anounce-2017
│   └── index.html
├── first-gameathon-update-2017
│   └── index.html
├── first-linux-install-party-2016
│   └── index.html
├── first-linux-install-party-2017
│   └── index.html
├── index.html
├── index.xml
├── page
│   ├── 1
│   │   └── index.html
│   └── 2
│       └── index.html
├── pentesting-announcement
│   └── index.html
├── trip-to-cambridge
│   └── index.html
└── welcome-freshers-2017
    └── index.html
```

However, the fix for this is fairly simple - instead of failing if the requested resource isn't a file, we perform a [further check](https://github.com/pisoc/pisoc.net/blob/6cacecf9982c82b5e5a55ed931ef4327803386a9/app.py#L33) to see if the resource the user requested is a directory. If it is, we assume there's an `index.html` inside the directory and try to send that to the user (failing if our assumption was wrong).

### Using python to execute shell commands

In `app.py`, we define a function called `rebuild`. Flask registers this as the view function for the "rebuild endpoint". Essentially, when we get requests sent to the URL associated with that endpoint, `rebuild` is run with the context of the request we recieved.  Once we get that far, two checks are performed. We ensure that the hook [came from GitHub](https://developer.github.com/webhooks/securing/#validating-payloads-from-github), and that the push was to the master branch (this is considered the "live" production copy of the codebase).  

If these two conditions are met, we use python's submodule package to do the following on the server the site is hosted on:

```shell
$ git submodule update --recursive --remote
$ git pull --recurse-submodules
$ hugo --cleanDestinationDir -s hugo/
```

This updates the "commit pointers" for all submodules (in our case, we only have one), checks out the appropriate commits from GitHub, and uses Hugo to rebuild our static content.

## Hugo

All of the "content" for the site (HTML, etc.) is generated by Hugo. Hugo is a static site generator that uses [markdown](https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet) files (the content of the site) and a theme (how to style that markdown) to generate static webapges. This static content isn't stored on GitHub, because it'd be redundant to keep it in more than one place (the server) if we have everything we need to recreate it.

All of the site's markdown is under the `hugo/content/` directory. News posts are under `hugo/content/news`, and the project writeups (like this article) are under `hugo/content/projects`. Likewise, the theme we get from the pisoc-theme repository is stored under `hugo/theme`.